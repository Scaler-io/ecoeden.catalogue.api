# build.yml
parameters:
  - name: imageName
    type: string
  - name: dockerHubServiceConnection
    type: string

steps:
  # Install Docker Compose
  - task: DockerInstaller@0
    inputs:
      dockerComposeVersion: 17.09.0-ce

  # # Clean Docker system (optional)
  # - task: Docker@2
  #   inputs:
  #     command: "run"
  #     arguments: "--rm docker system prune -a -f"
  #   displayName: "Clean Docker System"
  # Build Docker images using docker-compose with override file
  - task: DockerCompose@0
    inputs:
      containerregistry: "$(dockerHubServiceConnection)"
      dockerComposeFile: "**/docker-compose.yml"
      dockerComposeFileArgs: "-f docker-compose.yml -f docker-compose.override.yml"
      action: "Build services"
      additionalImageTags: "$(IMAGE_TAG)"
    displayName: "Build Docker Images"

    # Log in to Docker Hub (if not using service connection)
  - task: Docker@2
    inputs:
      command: "login"
      containerRegistry: "$(dockerHubServiceConnection)"

  # Push Docker images to Docker Hub
  - task: DockerCompose@0
    inputs:
      containerregistry: "$(dockerHubServiceConnection)"
      dockerComposeFile: "**/docker-compose.yml"
      dockerComposeFileArgs: "-f docker-compose.yml -f docker-compose.override.yml"
      action: "Push services"
    displayName: "Push Docker Images"
